<style>
	@import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap');

	* {
		font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
	}

	body {
		font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
		padding: 20px;
		background-color: #140c00;
		color: #ffffff;
		display: flex;
		justify-content: space-between;
		flex-direction: column;
		height: 140px;
	}

	.header {
		display: flex;
		align-items: center;
	}

	button {
		background-color: #fe9b11;
		color: #653d05;
		border: none;
		padding: 0;
		border-radius: 8px;
		cursor: pointer;
		width: 100%;
		font-weight: 550;
		font-size: 15px;
		letter-spacing: -0.2px;
		display: flex;
		align-items: stretch;
		justify-content: space-between;
		transition: opacity 0.2s ease-in-out;
	}

	.button-content {
		display: flex;
		align-items: center;
		padding: 12px 16px;
		position: relative;
	}

	button:not([disabled]):hover {
		background-color: #e08300;
	}

	#status {
		display: none;
	}

	#count {
		color: #653d05;
		font-size: 13px;
		font-weight: 550;
		opacity: 0.7;
		border-left: 2px solid #653d0530;
		padding: 12px 16px;
		display: flex;
		align-items: center;
	}

	button svg {
		margin-right: 6px;
	}

	.spinner {
		display: none;
		width: 12px;
		height: 12px;
		margin-right: 6px;
		border: 2.5px solid #653d05;
		border-radius: 50%;
		border-top-color: transparent;
		animation: spin 1s linear infinite;
		position: absolute;
		left: 16px;
	}

	@keyframes spin {
		to {
			transform: rotate(360deg);
		}
	}

	button.loading .spinner {
		display: block;
	}

	button.loading svg {
		visibility: hidden;
	}

	button.loading {
		cursor: wait;
	}

	button.loading:hover {
		background-color: #fe9b11;
	}
</style>

<div class="header">
	<svg width="44" height="60" viewBox="0 0 44 60" fill="none" xmlns="http://www.w3.org/2000/svg">
		<rect x="20.1365" width="3.49813" height="17.4907" fill="#FE9B11" />
		<rect x="6.29785" y="7.46729" width="3.49813" height="17.4907" transform="rotate(-45 6.29785 7.46729)" fill="#FE9B11" />
		<rect x="33.2456" y="4.83887" width="3.49813" height="17.4907" transform="rotate(45 33.2456 4.83887)" fill="#FE9B11" />
		<rect x="3.39478" y="20.4058" width="3.49813" height="34.9813" transform="rotate(-90 3.39478 20.4058)" fill="#FE9B11" />
		<path
			d="M28.5177 40.8116H31.764L32.0159 42.2389C32.4636 41.7351 33.0047 41.3433 33.639 41.0635C34.292 40.765 34.9916 40.6157 35.7379 40.6157C36.8386 40.6157 37.7715 40.8489 38.5364 41.3153C39.32 41.7818 39.917 42.4627 40.3274 43.3583C40.7565 44.2351 40.9711 45.3265 40.9711 46.6325V54.8041H37.361V47.1083C37.361 46.0262 37.1465 45.2146 36.7174 44.6736C36.2883 44.1325 35.6446 43.862 34.7864 43.862C33.9095 43.862 33.2379 44.1418 32.7715 44.7015C32.3237 45.2426 32.0998 46.0542 32.0998 47.1362V54.8041H28.5177V40.8116Z"
			fill="white"
		/>
		<path
			d="M26.1091 54.8041H22.8348L22.583 53.3489C22.1352 53.8713 21.5848 54.2817 20.9319 54.5802C20.2975 54.8601 19.6166 55 18.889 55C17.8069 55 16.874 54.7668 16.0905 54.3004C15.3069 53.834 14.7005 53.1623 14.2714 52.2855C13.8423 51.3899 13.6278 50.2892 13.6278 48.9832V40.8116H17.2378V48.5355C17.2378 49.5989 17.4431 50.4105 17.8535 50.9702C18.2826 51.5112 18.9356 51.7817 19.8125 51.7817C20.6707 51.7817 21.333 51.5019 21.7994 50.9422C22.2845 50.3825 22.527 49.5709 22.527 48.5075V40.8116H26.1091V54.8041Z"
			fill="white"
		/>
		<path
			d="M3.69802 50.2426C3.80996 50.709 3.99653 51.0635 4.25772 51.306C4.53757 51.5486 4.84541 51.7258 5.18123 51.8377C5.5357 51.931 5.89018 51.9777 6.24466 51.9777C6.89764 51.9777 7.4107 51.8564 7.78384 51.6139C8.15697 51.3527 8.34354 51.0262 8.34354 50.6344C8.34354 50.2986 8.21294 50.0374 7.95175 49.8508C7.69055 49.6456 7.35473 49.4963 6.94428 49.403C6.53384 49.2911 6.11406 49.1792 5.68496 49.0672C5.18123 48.9366 4.64018 48.7967 4.06182 48.6474C3.50212 48.4795 2.97041 48.2463 2.46668 47.9478C1.96294 47.6493 1.54317 47.2668 1.20735 46.8004C0.871527 46.3153 0.703617 45.709 0.703617 44.9814C0.703617 44.1232 0.936826 43.3676 1.40324 42.7146C1.88832 42.0616 2.55063 41.5486 3.39018 41.1754C4.24839 40.8023 5.2372 40.6157 6.3566 40.6157C7.68122 40.6157 8.80063 40.8956 9.71481 41.4553C10.629 42.015 11.2913 42.8172 11.7017 43.862L8.53943 44.7575C8.44615 44.4963 8.28757 44.2818 8.06369 44.1139C7.83981 43.9459 7.56928 43.8247 7.25212 43.7501C6.95361 43.6754 6.64578 43.6381 6.32861 43.6381C5.78757 43.6381 5.33981 43.7501 4.98533 43.9739C4.63085 44.1792 4.45361 44.4683 4.45361 44.8415C4.45361 45.0653 4.51891 45.2519 4.64951 45.4012C4.78011 45.5318 4.95735 45.6437 5.18123 45.737C5.42376 45.8303 5.69429 45.9142 5.99279 45.9889C6.30996 46.0635 6.65511 46.1474 7.02824 46.2407C7.6066 46.39 8.18496 46.5672 8.76331 46.7724C9.36033 46.959 9.90137 47.2015 10.3864 47.5C10.8902 47.7986 11.2913 48.1997 11.5898 48.7034C11.8883 49.2071 12.0562 49.8415 12.0935 50.6064C12.0935 51.4273 11.8603 52.1736 11.3939 52.8452C10.9275 53.4982 10.2558 54.0206 9.37898 54.4124C8.50212 54.8041 7.43869 55 6.18869 55C4.73347 55 3.49279 54.6922 2.46668 54.0765C1.45921 53.4609 0.7969 52.5 0.479736 51.1941L3.69802 50.2426Z"
			fill="white"
		/>
		<path
			d="M31.5224 38.6753C30.1605 38.6753 28.9478 38.3862 27.8844 37.8078C26.821 37.2108 25.9814 36.3806 25.3657 35.3171C24.7687 34.235 24.4702 32.9664 24.4702 31.5112C24.4702 30.0373 24.7781 28.7593 25.3937 27.6772C26.028 26.5951 26.8863 25.7649 27.9683 25.1865C29.0504 24.5895 30.2631 24.291 31.6064 24.291C32.9497 24.291 34.1624 24.5895 35.2445 25.1865C36.3265 25.7649 37.1848 26.5951 37.8191 27.6772C38.4534 28.7406 38.7706 30 38.7706 31.4552C38.7706 32.9291 38.4441 34.2071 37.7911 35.2891C37.1568 36.3712 36.2892 37.2108 35.1885 37.8078C34.1064 38.3862 32.8844 38.6753 31.5224 38.6753ZM31.4945 35.4571C32.0728 35.4571 32.6232 35.3171 33.1456 35.0373C33.668 34.7388 34.0971 34.3003 34.4329 33.722C34.7687 33.125 34.9366 32.3694 34.9366 31.4552C34.9366 30.5783 34.778 29.8507 34.4609 29.2724C34.1437 28.6753 33.7239 28.2369 33.2016 27.9571C32.6978 27.6586 32.1474 27.5093 31.5504 27.5093C30.9721 27.5093 30.431 27.6586 29.9273 27.9571C29.4422 28.2369 29.0504 28.6753 28.7519 29.2724C28.4721 29.8507 28.3322 30.597 28.3322 31.5112C28.3322 32.388 28.4721 33.125 28.7519 33.722C29.0318 34.3003 29.4142 34.7388 29.8993 35.0373C30.3844 35.3171 30.9161 35.4571 31.4945 35.4571Z"
			fill="white"
		/>
		<path
			d="M16.9879 38.6753C15.626 38.6753 14.432 38.3768 13.4058 37.7798C12.3797 37.1828 11.5775 36.3526 10.9991 35.2891C10.4208 34.2071 10.1316 32.9571 10.1316 31.5391C10.1316 30.1026 10.4208 28.8433 10.9991 27.7612C11.5775 26.6791 12.3891 25.8302 13.4338 25.2145C14.4786 24.5989 15.682 24.291 17.0439 24.291C18.5178 24.291 19.8237 24.6548 20.9618 25.3824C22.1185 26.11 22.9301 27.0895 23.3965 28.3209L20.0663 29.2724C19.8424 28.7313 19.4693 28.3022 18.9469 27.985C18.4432 27.6679 17.8648 27.5093 17.2118 27.5093C16.5588 27.5093 15.9805 27.6772 15.4767 28.013C14.9917 28.3488 14.6092 28.8153 14.3293 29.4123C14.0682 30.0093 13.9376 30.7089 13.9376 31.5112C13.9376 32.7238 14.2361 33.6847 14.8331 34.3936C15.4301 35.1026 16.2323 35.4571 17.2398 35.4571C17.8741 35.4571 18.4525 35.3078 18.9749 35.0093C19.4973 34.6921 19.889 34.263 20.1502 33.722L23.4525 34.6735C22.9487 35.8862 22.1092 36.8563 20.9338 37.5839C19.7771 38.3115 18.4618 38.6753 16.9879 38.6753Z"
			fill="white"
		/>
		<path d="M4.34717 24.4873H7.92926V38.4798H4.34717V24.4873Z" fill="white" />
	</svg>
</div>
<button id="export-button">
	<div class="button-content">
		<div class="spinner"></div>
		<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
			<path d="M3.5 2C2.67157 2 2 2.67157 2 3.5V6C2 6.82843 2.67157 7.5 3.5 7.5H6C6.82843 7.5 7.5 6.82843 7.5 6V3.5C7.5 2.67157 6.82843 2 6 2H3.5Z" fill="#653D05" />
			<path d="M3.5 8.5C2.67157 8.5 2 9.17157 2 10V12.5C2 13.3284 2.67157 14 3.5 14H6C6.82843 14 7.5 13.3284 7.5 12.5V10C7.5 9.17157 6.82843 8.5 6 8.5H3.5Z" fill="#653D05" />
			<path d="M10 8.5C9.17157 8.5 8.5 9.17157 8.5 10V12.5C8.5 13.3284 9.17157 14 10 14H12.5C13.3284 14 14 13.3284 14 12.5V10C14 9.17157 13.3284 8.5 12.5 8.5H10Z" fill="#653D05" />
			<path d="M9 5.25V4.25H10.75V2.5H11.75V4.25H13.5V5.25H11.75V7H10.75V5.25H9Z" fill="#653D05" />
		</svg>
		<span class="button-text">Generate new set</span>
	</div>
	<div id="count">Select the iconMaster</div>
</button>
<div id="status"></div>

<script>
	const statusEl = document.getElementById('status');
	const countEl = document.getElementById('count');
	const exportButton = document.getElementById('export-button');
	const buttonText = exportButton.querySelector('.button-text');
	let hasSelection = false;

	// Handle button click
	exportButton.onclick = () => {
		if (!hasSelection) {
			figma.notify('Please select a node first');
			return;
		}
		exportButton.classList.add('loading');
		buttonText.textContent = 'Generating new set';
		statusEl.textContent = 'Scanning for child nodes...';
		parent.postMessage(
			{
				pluginMessage: {type: 'export-children-as-svg'},
			},
			'*'
		);
	};

	onmessage = (event) => {
		const message = event.data.pluginMessage;

		if (message.type === 'initial-count') {
			hasSelection = message.count > 0;
			if (hasSelection) {
				countEl.textContent = `${message.count} icons`;
				exportButton.style.opacity = '1';
				exportButton.style.cursor = 'pointer';
			} else {
				countEl.textContent = 'Select an artboard';
				exportButton.style.cursor = 'not-allowed';
			}
		}

		if (message.type === 'update-count') {
			statusEl.textContent = `Found ${message.count} nodes to export...`;
		}

		if (message.type === 'export-error') {
			// Reset loading state
			exportButton.classList.remove('loading');
			buttonText.textContent = 'Generate new set';
			statusEl.textContent = '';
		}

		if (message.type === 'download-ready') {
			statusEl.textContent = 'Creating download...';

			// Create download link
			const link = document.createElement('a');
			link.href = 'data:application/zip;base64,' + message.content;
			link.download = 'iconsMaster.zip';

			// Trigger download
			document.body.appendChild(link);
			link.click();
			document.body.removeChild(link);

			// Update status and remove loading state
			statusEl.textContent = 'Download complete!';
			exportButton.classList.remove('loading');
			buttonText.textContent = 'Generate new set';
		}
	};
</script>

